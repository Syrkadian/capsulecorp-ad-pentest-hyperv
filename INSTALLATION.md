# Installation Process

Please, read the whole installation process carefully. It is not entirely a copy-and-paste installation guide :exclamation: 

## 1. Enable Hyper-V feature

To enable Hyper-V with some extra features, execute the following commands.

```powershell
Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
Enable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform
Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
```

## 2. Install & Configure WSL

### Windows Subsystem for Linux (WSL)

Configure the WSL to version 1, so it uses the bridge Interface, instead of NAT in v2. Execute the following commands on Powershell as Administrator.

```powershell
wsl --install -d ubuntu
wsl --set-version ubuntu 1
```

### Ansible

Once you have downloaded your Ubuntu machine, you'll be prompted to create a username/password, then execute the following commands as your new user (not root) to install Ansible.

```bash
sudo apt update
sudo apt install python3-pip -y
echo 'PATH=~/.local/bin:$PATH' >> ~/.bashrc
source ~/.bashrc
pip install --user ansible==7.3.0
pip install pywinrm==0.4.3 --user
```

Create the file `/etc/wsl.conf` with the following content or add it to the bottom of the existing contents, so ansible can connect to the Linux machine through SSH. 

```bash
# Enable extra metadata options by default
[automount]
enabled = true
root = /mnt/
options = "metadata,umask=77,fmask=11"
mountFsTab = false
```

Start a new Powershell terminal as Administrator and execute the following command:

```powershell
Restart-Service LxssManager
```

### Vagrant

To install Vagrant, you need to execute the following commands:

> :warning: vagrant version **2.4.1** is required

```bash
echo 'export VAGRANT_WSL_ENABLE_WINDOWS_ACCESS="1"' >> ~/.bashrc
echo 'export VAGRANT_DEFAULT_PROVIDER=hyperv' >> ~/.bashrc
source ~/.bashrc
wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install vagrant -y
```

> A few vagrant plugins are required to launch and provision all of the VMs.  If any of the below vagrant plugin install commands fail, open up an administrative PowerShell prompt and run the command `Restart-Service LxssManager`.

```bash
vagrant plugin install winrm
vagrant plugin install winrm-fs
vagrant plugin install winrm-elevated
vagrant plugin install vagrant-reload
```

# Laboratory

Download the repository to `/mnt/c/`, so ssh will work through Ubuntu WSL.

```bash
git clone https://github.com/Syrkadian/capsulecorp-ad-pentest-hyperv.git
```

Open a new Ubuntu WSL terminal as an Administrator, and execute the following commands and wait for it to finish.

> :NOTE: You must install "kms" and "goku" first, manually reboot both machines, and then install the other AD machine you want to use.

```bash
cd /mnt/c/capsulecorp-ad-pentest-hyperv/
vagrant up kms goku --provision
```

Manually reboot "kms" and "goku" once the they install properly. Install the remaining vms.

```bash
cd /mnt/c/capsulecorp-ad-pentest-hyperv/
vagrant up development kali krillin raditz gohan tien --provision
```

Finally, you need to set the `EnhancedSessionTransportType` on each machine to take advantage of Hyper-V clipboard capabilities. The VMs must be turned off when you apply the Enhanced Session Transport Type setting. This is because the setting requires a reconfiguration of the VM's hardware settings, which cannot be done while the VM is running. 

Execute the following commands on PowerShell as Administrator:
```powershell
Set-VM -VMName mad_kms,mad_kali -EnhancedSessionTransportType HvSocket
Set-VM -VMName mad_development,mad_goku,mad_krillin,mad_raditz,mad_gohan,mad_tien -EnhancedSessionTransportType VMBus
```
Once the setting is applied, start the VMs again. 

After starting the VMs with the new setting, some VMs might need an additional reboot to fully apply the settings, especially if integration services are updated or installed during the first boot. 

# Uninstall

The lab environment can be nuked with the following commands:

1. Run the following commands in an Ubuntu WSL terminal as an Administrator:

```bash
vagrant destroy kms development kali goku krillin raditz gohan tien -f
rm -rf /mnt/c/capsulecorp-pentest-hyperv/
vagrant box list | cut -d ' ' -f 1 | xargs -I {} bash -c "vagrant box remove -f {}"
```

2. To disable Hyper-V, run the following commands in a PowerShell terminal as Administrator.

> If you want to enable it again later, toggle `off` to `auto`.
```powershell
# To Turn it off
bcdedit /set hypervisorlaunchtype off
```

# To uninstall it completely
```
Disable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
Disable-WindowsOptionalFeature -Online -FeatureName HypervisorPlatform
Disable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform
```



